{% extends 'base.html' %}

{% block title %}Admin Dashboard - Job Portal{% endblock %}

{% block content %}
<style>
    .dashboard-header {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .stat-card h3 {
        font-size: 2rem;
        color: #4CAF50;
        margin-bottom: 0.5rem;
    }
    
    .stat-card p {
        color: #666;
        font-size: 1rem;
    }
    
    .tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #ddd;
    }
    
    .tab {
        padding: 1rem 2rem;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 1rem;
        color: #666;
        border-bottom: 3px solid transparent;
    }
    
    .tab.active {
        color: #4CAF50;
        border-bottom-color: #4CAF50;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    table {
        width: 100%;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    table thead {
        background: #333;
        color: white;
    }
    
    table th,
    table td {
        padding: 1rem;
        text-align: left;
    }
    
    table tbody tr:hover {
        background: #f5f5f5;
    }
    
    .badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    
    .badge-admin {
        background: #ff9800;
        color: white;
    }
    
    .badge-employer {
        background: #2196F3;
        color: white;
    }
    
    .badge-seeker {
        background: #4CAF50;
        color: white;
    }
    
    .badge-pending {
        background: #FFC107;
        color: white;
    }
    
    .badge-accepted {
        background: #4CAF50;
        color: white;
    }
    
    .badge-rejected {
        background: #f44336;
        color: white;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-small {
        padding: 0.4rem 0.8rem;
        font-size: 0.85rem;
    }
</style>

<div class="dashboard-header">
    <h1>Admin Dashboard</h1>
    <p>Manage users, jobs, and applications</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3 id="total-users">0</h3>
        <p>Total Users</p>
    </div>
    <div class="stat-card">
        <h3 id="total-jobs">0</h3>
        <p>Total Jobs</p>
    </div>
    <div class="stat-card">
        <h3 id="total-applications">0</h3>
        <p>Total Applications</p>
    </div>
    <div class="stat-card">
        <h3 id="total-employers">0</h3>
        <p>Employers</p>
    </div>
</div>

<div class="tabs">
    <button class="tab active" onclick="showTab('users')">Users</button>
    <button class="tab" onclick="showTab('jobs')">Jobs</button>
    <button class="tab" onclick="showTab('applications')">Applications</button>
</div>

<!-- Users Tab -->
<div id="users-tab" class="tab-content active">
    <h2>All Users</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th>Name</th>
                <th>Joined</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="users-table-body">
            <tr>
                <td colspan="7" style="text-align: center;">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Jobs Tab -->
<div id="jobs-tab" class="tab-content">
    <h2>All Jobs</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Company</th>
                <th>Employer</th>
                <th>Location</th>
                <th>Type</th>
                <th>Posted</th>
                <th>Applications</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="jobs-table-body">
            <tr>
                <td colspan="9" style="text-align: center;">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Applications Tab -->
<div id="applications-tab" class="tab-content">
    <h2>All Applications</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Applicant</th>
                <th>Job Title</th>
                <th>Company</th>
                <th>Status</th>
                <th>Applied Date</th>
                <th>Resume</th>
            </tr>
        </thead>
        <tbody id="applications-table-body">
            <tr>
                <td colspan="7" style="text-align: center;">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    const token = localStorage.getItem('access_token');
    const userRole = localStorage.getItem('user_role');
    
    if (!token || userRole !== 'admin') {
        window.location.href = '/login';
    }
    
    function showTab(tabName) {
        
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
    }
    
    
    async function fetchUsers() {
        try {
            const response = await fetch('/api/accounts/users/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const users = await response.json();
            
            document.getElementById('total-users').textContent = users.length;
            
            const employersCount = users.filter(u => u.role === 'employer').length;
            document.getElementById('total-employers').textContent = employersCount;
            
            const tableBody = document.getElementById('users-table-body');
            
            if (users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-${user.role === 'admin' ? 'admin' : user.role === 'employer' ? 'employer' : 'seeker'}">${user.role}</span></td>
                    <td>${user.first_name} ${user.last_name}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <div class="action-buttons">
                            ${user.role !== 'admin' ? `<button class="btn btn-danger btn-small" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error fetching users:', error);
        }
    }
    
    
    async function fetchJobs() {
        try {
            const response = await fetch('/api/jobs/admin/all/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const jobs = await response.json();
            
            document.getElementById('total-jobs').textContent = jobs.length;
            
            const tableBody = document.getElementById('jobs-table-body');
            
            if (jobs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No jobs found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = jobs.map(job => `
                <tr>
                    <td>${job.id}</td>
                    <td>${job.title}</td>
                    <td>${job.company_name}</td>
                    <td>${job.employer_name}</td>
                    <td>${job.location}</td>
                    <td>${job.job_type}</td>
                    <td>${new Date(job.posted_date).toLocaleDateString()}</td>
                    <td>${job.total_applications}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-danger btn-small" onclick="deleteJob(${job.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error fetching jobs:', error);
        }
    }
    
    
    async function fetchApplications() {
        try {
            const response = await fetch('/api/applications/admin/all/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            const applications = await response.json();
            
            document.getElementById('total-applications').textContent = applications.length;
            
            const tableBody = document.getElementById('applications-table-body');
            
            if (applications.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No applications found</td></tr>';
                return;
            }
            
            tableBody.innerHTML = applications.map(app => `
                <tr>
                    <td>${app.id}</td>
                    <td>${app.applicant_name}</td>
                    <td>${app.job.title}</td>
                    <td>${app.job.company_name}</td>
                    <td><span class="badge badge-${app.status}">${app.status}</span></td>
                    <td>${new Date(app.applied_date).toLocaleDateString()}</td>
                    <td><a href="${app.resume}" target="_blank" class="btn btn-small">View</a></td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error fetching applications:', error);
        }
    }
    
    async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user?')) return;
        
        try {
            const response = await fetch(`/api/accounts/users/${userId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                showMessage('User deleted successfully', 'success');
                fetchUsers();
            } else {
                showMessage('Failed to delete user', 'error');
            }
        } catch (error) {
            showMessage('An error occurred', 'error');
        }
    }
    

    async function deleteJob(jobId) {
        if (!confirm('Are you sure you want to delete this job?')) return;
        
        try {
            const response = await fetch(`/api/jobs/${jobId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (response.ok) {
                showMessage('Job deleted successfully', 'success');
                fetchJobs();
            } else {
                showMessage('Failed to delete job', 'error');
            }
        } catch (error) {
            showMessage('An error occurred', 'error');
        }
    }
    
    
    fetchUsers();
    fetchJobs();
    fetchApplications();
</script>
{% endblock %}